name: Generate Dashboard Assets

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

permissions:
  contents: write

jobs:
  generate-all:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Create dist directory
        run: mkdir -p dist

      # Generate Snake Animation
      - name: Generate snake SVG
        uses: Platane/snk/svg-only@v3
        with:
          github_user_name: deshadspace
          outputs: |
            dist/github-snake.svg
            dist/github-snake-dark.svg?palette=github-dark

      # Try alternative stats sources
      - name: Download GitHub stats from primary source
        id: stats_primary
        continue-on-error: true
        run: |
          echo "Trying primary stats source..."
          curl -f -L --retry 3 --retry-delay 5 \
            "https://github-readme-stats.vercel.app/api?username=deshadspace&show_icons=true&theme=tokyonight&hide_border=true&bg_color=0d1117&title_color=00bcd4&icon_color=00bcd4&text_color=ffffff&include_all_commits=true&count_private=true" \
            -H "User-Agent: Mozilla/5.0" \
            -o dist/stats-main.svg
          
          # Check if it's actually an SVG
          if grep -q "<svg" dist/stats-main.svg 2>/dev/null; then
            echo "‚úÖ Valid SVG downloaded"
            exit 0
          else
            echo "‚ùå Not a valid SVG, trying alternative..."
            rm -f dist/stats-main.svg
            exit 1
          fi

      - name: Download GitHub stats from alternative source
        if: steps.stats_primary.outcome == 'failure'
        continue-on-error: true
        run: |
          echo "Trying alternative stats source..."
          curl -f -L --retry 3 --retry-delay 5 \
            "https://github-readme-stats-sigma-five.vercel.app/api?username=deshadspace&show_icons=true&theme=tokyonight&hide_border=true&bg_color=0d1117&title_color=00bcd4&icon_color=00bcd4&text_color=ffffff" \
            -H "User-Agent: Mozilla/5.0" \
            -o dist/stats-main.svg

      - name: Download languages from primary source
        id: langs_primary
        continue-on-error: true
        run: |
          sleep 3
          echo "Trying primary languages source..."
          curl -f -L --retry 3 --retry-delay 5 \
            "https://github-readme-stats.vercel.app/api/top-langs?username=deshadspace&layout=compact&theme=tokyonight&hide_border=true&bg_color=0d1117&title_color=00bcd4&text_color=ffffff&langs_count=8" \
            -H "User-Agent: Mozilla/5.0" \
            -o dist/stats-langs.svg
          
          # Check if it's actually an SVG
          if grep -q "<svg" dist/stats-langs.svg 2>/dev/null; then
            echo "‚úÖ Valid SVG downloaded"
            exit 0
          else
            echo "‚ùå Not a valid SVG, trying alternative..."
            rm -f dist/stats-langs.svg
            exit 1
          fi

      - name: Download languages from alternative source
        if: steps.langs_primary.outcome == 'failure'
        continue-on-error: true
        run: |
          echo "Trying alternative languages source..."
          curl -f -L --retry 3 --retry-delay 5 \
            "https://github-readme-stats-sigma-five.vercel.app/api/top-langs?username=deshadspace&layout=compact&theme=tokyonight&hide_border=true&bg_color=0d1117&title_color=00bcd4&text_color=ffffff" \
            -H "User-Agent: Mozilla/5.0" \
            -o dist/stats-langs.svg

      # Create fallback badges if stats failed
      - name: Create fallback badges if needed
        run: |
          if [ ! -f dist/stats-main.svg ] || ! grep -q "<svg" dist/stats-main.svg 2>/dev/null; then
            echo "Creating fallback stats badge..."
            curl -f "https://img.shields.io/badge/GitHub-Stats-00bcd4?style=for-the-badge&logo=github&logoColor=white" \
              -o dist/stats-main.svg
          fi
          
          if [ ! -f dist/stats-langs.svg ] || ! grep -q "<svg" dist/stats-langs.svg 2>/dev/null; then
            echo "Creating fallback languages badge..."
            curl -f "https://img.shields.io/badge/Top-Languages-00bcd4?style=for-the-badge&logo=github&logoColor=white" \
              -o dist/stats-langs.svg
          fi

      # Verify all files
      - name: Verify all files
        run: |
          echo "=========================================="
          echo "üìÅ ALL FILES IN DIST:"
          echo "=========================================="
          ls -lah dist/
          echo ""
          echo "=========================================="
          echo "üìä FILE VALIDATION:"
          echo "=========================================="
          for file in dist/*.svg; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              size=$(wc -c < "$file")
              if grep -q "<svg" "$file" 2>/dev/null; then
                echo "‚úÖ $filename: ${size} bytes - Valid SVG"
              else
                echo "‚ö†Ô∏è  $filename: ${size} bytes - May not be valid SVG"
                head -c 200 "$file"
              fi
            fi
          done

      # Push all files to output branch
      - name: Push to output branch
        uses: crazy-max/ghaction-github-pages@v4
        with:
          target_branch: output
          build_dir: dist
          keep_history: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}